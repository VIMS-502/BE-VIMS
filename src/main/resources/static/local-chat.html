<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>로컬 채팅 테스트</title>
    <script src="./sockjs.min.js"></script>
    <script src="./stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #messages { height: 300px; border: 1px solid #ccc; overflow-y: scroll; padding: 10px; margin: 10px 0; }
        input { padding: 5px; margin: 5px; }
        button { padding: 5px 10px; margin: 5px; }
    </style>
</head>
<body>
    <h2>채팅 테스트</h2>
    
    <div id="connect-form">
        <input type="text" id="username" placeholder="사용자명">
        <input type="text" id="roomId" placeholder="방ID">
        <button onclick="connect()">연결</button>
    </div>
    
    <div id="chat-form" style="display:none;">
        <h3 id="room-title"></h3>
        <div id="messages"></div>
        <input type="text" id="messageInput" placeholder="메시지를 입력하세요">
        <button onclick="sendMessage()">전송</button>
        <button onclick="disconnect()">나가기</button>
    </div>

    <script>
        let stompClient = null;
        let username = '';
        let roomId = '';

        // 라이브러리 확인
        window.onload = function() {
            console.log('SockJS loaded:', typeof SockJS);
            console.log('Stomp loaded:', typeof Stomp);
            
            if (typeof SockJS === 'undefined') {
                alert('SockJS 라이브러리가 로드되지 않았습니다.');
                return;
            }
            if (typeof Stomp === 'undefined') {
                alert('Stomp 라이브러리가 로드되지 않았습니다.');
                return;
            }
        };

        function connect() {
            username = document.getElementById('username').value;
            roomId = document.getElementById('roomId').value;
            
            if (!username || !roomId) {
                alert('사용자명과 방ID를 입력하세요');
                return;
            }

            try {
                const socket = new SockJS('/ws');
                stompClient = Stomp.over(socket);
                
                stompClient.connect({}, function(frame) {
                    console.log('Connected: ' + frame);
                    
                    // 채팅 메시지 구독
                    stompClient.subscribe('/topic/chat.' + roomId, function(message) {
                        const msg = JSON.parse(message.body);
                        showMessage(msg);
                    });

                    // 입장 메시지 전송
                    stompClient.send('/app/chat.join', {}, JSON.stringify({
                        senderId: username,
                        senderName: username,
                        roomId: roomId,
                        type: 'JOIN'
                    }));

                    // UI 변경
                    document.getElementById('connect-form').style.display = 'none';
                    document.getElementById('chat-form').style.display = 'block';
                    document.getElementById('room-title').textContent = roomId + ' 방 (' + username + ')';
                    document.getElementById('messageInput').focus();
                    
                }, function(error) {
                    console.error('Connection error:', error);
                    alert('연결 실패: ' + error);
                });
                
            } catch (e) {
                console.error('Connect error:', e);
                alert('연결 오류: ' + e.message);
            }
        }

        function sendMessage() {
            const content = document.getElementById('messageInput').value.trim();
            if (content && stompClient && stompClient.connected) {
                stompClient.send('/app/chat.send', {}, JSON.stringify({
                    senderId: username,
                    senderName: username,
                    roomId: roomId,
                    content: content,
                    type: 'CHAT'
                }));
                document.getElementById('messageInput').value = '';
            }
        }

        function disconnect() {
            if (stompClient) {
                stompClient.disconnect();
            }
            document.getElementById('connect-form').style.display = 'block';
            document.getElementById('chat-form').style.display = 'none';
            document.getElementById('messages').innerHTML = '';
        }

        function showMessage(message) {
            const messages = document.getElementById('messages');
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString();
            
            if (message.type === 'CHAT') {
                div.innerHTML = '<b>' + message.senderName + '</b> [' + time + ']: ' + message.content;
            } else {
                div.innerHTML = '<i style="color: #666;">' + message.content + '</i>';
            }
            
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }

        // Enter 키로 메시지 전송
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && document.getElementById('messageInput') === document.activeElement) {
                sendMessage();
            }
        });
    </script>
</body>
</html>