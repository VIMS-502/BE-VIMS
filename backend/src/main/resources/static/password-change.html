<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>비밀번호 변경</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 400px; margin: auto; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        label, input, button { display: block; width: 100%; margin-bottom: 12px; }
        .result { margin-top: 16px; color: #007700; }
        .error { color: #cc0000; }
        .hidden { display: none; }
    </style>
</head>
<body>
<div class="container">
    <h2>비밀번호 변경</h2>
    <label for="email">이메일</label>
    <input type="email" id="email" placeholder="이메일을 입력하세요" required />
    <button id="sendCodeBtn" onclick="sendCode()">인증코드 전송</button>

    <div id="codeSection" class="hidden">
        <label for="code">인증코드</label>
        <input type="text" id="code" placeholder="이메일로 받은 인증코드 입력" />
        <button id="verifyCodeBtn" onclick="verifyCode()">코드 확인</button>
    </div>

    <div id="passwordSection" class="hidden">
        <label for="newPassword">새 비밀번호</label>
        <input type="password" id="newPassword" placeholder="새 비밀번호 입력" />
        <label for="newPasswordConfirm">새 비밀번호 확인</label>
        <input type="password" id="newPasswordConfirm" placeholder="새 비밀번호 재입력" />
        <button id="changePasswordBtn" onclick="changePassword()">비밀번호 변경</button>
    </div>

    <div id="result" class="result"></div>
</div>
<script>
    let emailValue = '';
    let codeChecked = false;

    function sendCode() {
        const email = document.getElementById('email').value;
        const resultDiv = document.getElementById('result');
        resultDiv.textContent = '';
        resultDiv.className = 'result';
        if (!email) {
            resultDiv.textContent = '이메일을 입력하세요.';
            resultDiv.className = 'result error';
            return;
        }
        fetch('/api/auth/send-code/password/change?email=' + encodeURIComponent(email), {
            method: 'POST',
        })
        .then(response => {
            if (response.ok) {
                resultDiv.textContent = '인증코드가 전송되었습니다. 이메일을 확인하세요.';
                document.getElementById('codeSection').classList.remove('hidden');
                emailValue = email;
            } else {
                return response.text().then(text => { throw new Error(text || '오류가 발생했습니다.'); });
            }
        })
        .catch(error => {
            resultDiv.textContent = error.message;
            resultDiv.className = 'result error';
        });
    }

    function verifyCode() {
        const code = document.getElementById('code').value;
        const resultDiv = document.getElementById('result');
        resultDiv.textContent = '';
        resultDiv.className = 'result';
        if (!code) {
            resultDiv.textContent = '인증코드를 입력하세요.';
            resultDiv.className = 'result error';
            return;
        }
        fetch(`/api/auth/verify-code/password/change?email=${encodeURIComponent(emailValue)}&code=${encodeURIComponent(code)}`, {
            method: 'POST',
        })
        .then(response => {
            if (response.ok) {
                resultDiv.textContent = '인증코드가 확인되었습니다. 새 비밀번호를 입력하세요.';
                document.getElementById('passwordSection').classList.remove('hidden');
                codeChecked = true;
            } else {
                return response.text().then(text => { throw new Error(text || '인증코드가 일치하지 않습니다.'); });
            }
        })
        .catch(error => {
            resultDiv.textContent = error.message;
            resultDiv.className = 'result error';
        });
    }

    function changePassword() {
        const newPassword = document.getElementById('newPassword').value;
        const newPasswordConfirm = document.getElementById('newPasswordConfirm').value;
        const code = document.getElementById('code').value;
        const resultDiv = document.getElementById('result');
        resultDiv.textContent = '';
        resultDiv.className = 'result';
        if (!codeChecked) {
            resultDiv.textContent = '먼저 인증코드를 확인하세요.';
            resultDiv.className = 'result error';
            return;
        }
        if (!newPassword || !newPasswordConfirm) {
            resultDiv.textContent = '새 비밀번호를 모두 입력하세요.';
            resultDiv.className = 'result error';
            return;
        }
        if (newPassword !== newPasswordConfirm) {
            resultDiv.textContent = '비밀번호가 일치하지 않습니다.';
            resultDiv.className = 'result error';
            return;
        }
        fetch('/api/auth/me/password/change', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                email: emailValue,
                code: code,
                newPassword: newPassword,
                newPasswordConfirm: newPasswordConfirm
            })
        })
        .then(response => {
            if (response.ok) {
                resultDiv.textContent = '비밀번호가 성공적으로 변경되었습니다!';
                resultDiv.className = 'result';
                document.getElementById('passwordSection').classList.add('hidden');
            } else {
                return response.text().then(text => { throw new Error(text || '비밀번호 변경에 실패했습니다.'); });
            }
        })
        .catch(error => {
            resultDiv.textContent = error.message;
            resultDiv.className = 'result error';
        });
    }
</script>
</body>
</html> 