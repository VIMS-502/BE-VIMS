<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIMS - ì¢…í•© ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
    <script src="sockjs.min.js"></script>
    <script src="stomp.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            height: 100vh;
            box-sizing: border-box;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            height: calc(100vh - 40px); /* ì „ì²´ í™”ë©´ì—ì„œ body padding ì œì™¸ */
            display: flex;
            flex-direction: column;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            flex-shrink: 0; /* í—¤ë” í¬ê¸° ê³ ì • */
        }
        .main-content {
            display: flex;
            flex: 1; /* ë‚¨ì€ ê³µê°„ ëª¨ë‘ ì°¨ì§€ */
            overflow: hidden;
        }
        .sidebar {
            width: 250px;
            background: #34495e;
            color: white;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto; /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ í™œì„±í™” */
        }
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            background: #ecf0f1;
            padding: 15px;
            border-bottom: 1px solid #bdc3c7;
            font-weight: bold;
        }
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #fafafa;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            max-width: 80%;
        }
        .message.own {
            background: #3498db;
            color: white;
            margin-left: auto;
        }
        .message.other {
            background: white;
            border: 1px solid #ddd;
        }
        .message.system {
            background: #f39c12;
            color: white;
            text-align: center;
            margin: 5px auto;
            max-width: 60%;
        }
        .message.announcement {
            background: #e74c3c;
            color: white;
            border: 2px solid #c0392b;
            font-weight: bold;
        }
        .input-area {
            padding: 15px;
            border-top: 1px solid #bdc3c7;
            background: white;
        }
        .input-group {
            display: flex;
            gap: 10px;
        }
        .input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary {
            background: #3498db;
            color: white;
        }
        .btn-success {
            background: #27ae60;
            color: white;
        }
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        .control-panel {
            margin-bottom: 20px;
        }
        .control-panel h3 {
            margin-top: 0;
            color: #ecf0f1;
        }
        .form-group {
            margin: 10px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            color: #bdc3c7;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #7f8c8d;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .participants {
            margin-top: 20px;
        }
        .participant {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background: #2c3e50;
            border-radius: 4px;
            cursor: pointer;
        }
        .participant:hover {
            background: #34495e;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status.connected {
            background: #d5eda6;
            color: #27ae60;
        }
        .status.disconnected {
            background: #f5b7b1;
            color: #e74c3c;
        }
        .dm-window {
            position: fixed;
            top: 50px;
            right: 20px;
            width: 300px;
            height: 400px;
            background: white;
            border: 2px solid #3498db;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
        }
        .dm-header {
            background: #3498db;
            color: white;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .dm-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .dm-input {
            padding: 10px;
            border-top: 1px solid #ddd;
        }
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ VIMS - ì¢…í•© ì±„íŒ… í…ŒìŠ¤íŠ¸</h1>
            <p>ê°•ì˜ì‹¤ ìƒì„±, ì±„íŒ…, DM í…ŒìŠ¤íŠ¸</p>
        </div>
        
        <div class="main-content">
            <!-- ì‚¬ì´ë“œë°”: ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
            <div class="sidebar">
                <!-- ì—°ê²° ìƒíƒœ -->
                <div id="connectionStatus" class="status disconnected">
                    ğŸ”´ ì—°ê²° ëŠê¹€
                </div>
                
                <!-- ì‚¬ìš©ì ì„¤ì • -->
                <div class="control-panel">
                    <h3>ğŸ‘¤ ì‚¬ìš©ì ì„¤ì •</h3>
                    <div class="form-group">
                        <label>ì‚¬ìš©ì ID</label>
                        <input type="text" id="userId" placeholder="123" value="1">
                    </div>
                    <div class="form-group">
                        <label>ì‚¬ìš©ì ì´ë¦„</label>
                        <input type="text" id="userName" placeholder="ê¹€ì² ìˆ˜" value="ê¹€ì² ìˆ˜">
                    </div>
                    <div class="form-group">
                        <label>ì—­í• </label>
                        <select id="userRole">
                            <option value="STUDENT">í•™ìƒ</option>
                            <option value="INSTRUCTOR">ê°•ì‚¬</option>
                            <option value="TA">ì¡°êµ</option>
                        </select>
                    </div>
                </div>
                
                <!-- ë°© ê´€ë¦¬ -->
                <div class="control-panel">
                    <h3>ğŸ« ë°© ê´€ë¦¬</h3>
                    <div class="form-group">
                        <label>ë°© ì œëª©</label>
                        <input type="text" id="roomTitle" placeholder="í…ŒìŠ¤íŠ¸ ë°©" value="í…ŒìŠ¤íŠ¸ ë°©">
                    </div>
                    <div class="form-group">
                        <label>ë°© ì„¤ëª…</label>
                        <input type="text" id="roomDescription" placeholder="ë°© ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" value="">
                    </div>
                    <button class="btn btn-success" onclick="createRoom()">ë°© ìƒì„±</button>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label>ì…ì¥í•  ë°© ì½”ë“œ</label>
                        <input type="text" id="joinRoomCode" placeholder="ABC123" value="">
                    </div>
                    <button class="btn btn-primary" onclick="joinRoom()">ë°© ì…ì¥</button>
                    <button class="btn btn-warning" onclick="leaveRoom()">ë°© í‡´ì¥</button>
                    
                    <div id="createdRoomInfo" style="margin-top: 15px; display: none;">
                        <div class="status connected">
                            <strong>ìƒì„±ëœ ë°© ì •ë³´:</strong><br>
                            ë°© ì½”ë“œ: <span id="createdRoomCode"></span><br>
                            ë°© ì œëª©: <span id="createdRoomTitle"></span>
                        </div>
                    </div>
                </div>
                
                <!-- ì°¸ì—¬ì ëª©ë¡ -->
                <div class="participants">
                    <h3>ğŸ‘¥ ì°¸ì—¬ì ëª©ë¡</h3>
                    <div id="participantsList">
                        <p style="color: #bdc3c7; font-size: 12px;">ë°©ì— ì…ì¥í•´ì£¼ì„¸ìš”</p>
                    </div>
                </div>
            </div>
            
            <!-- ì±„íŒ… ì˜ì—­ -->
            <div class="chat-area">
                <div class="chat-header" id="chatHeader">
                    ğŸ’¬ ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”
                </div>
                
                <div class="messages" id="messages">
                    <div class="message system">
                        VIMS ì±„íŒ… ì‹œìŠ¤í…œì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤! ğŸ‰<br>
                        1. ì‚¬ìš©ì ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”<br>
                        2. ë°©ì„ ìƒì„±í•˜ê±°ë‚˜ ë°© ì½”ë“œë¡œ ê¸°ì¡´ ë°©ì— ì…ì¥í•˜ì„¸ìš”<br>
                        3. ì±„íŒ…ì„ ì‹œì‘í•˜ì„¸ìš”!
                    </div>
                </div>
                
                <div class="input-area">
                    <div class="input-group">
                        <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." disabled>
                        <button class="btn btn-primary" onclick="sendMessage()" disabled id="sendBtn">ì „ì†¡</button>
                        <button class="btn btn-warning" onclick="sendAnnouncement()" disabled id="announcementBtn">ê³µì§€</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- DM ì°½ -->
    <div id="dmWindow" class="dm-window">
        <div class="dm-header">
            <span id="dmPartnerName">DM</span>
            <button class="close-btn" onclick="closeDM()">&times;</button>
        </div>
        <div id="dmMessages" class="dm-messages"></div>
        <div class="dm-input">
            <div class="input-group">
                <input type="text" id="dmMessageInput" placeholder="DMì„ ì…ë ¥í•˜ì„¸ìš”...">
                <button class="btn btn-primary" onclick="sendDM()">ì „ì†¡</button>
            </div>
        </div>
    </div>

    <script>
        let stompClient = null;
        let currentRoomCode = null;
        let currentUserId = null;
        let currentUserName = null;
        let currentDmPartner = null;
        let participants = new Map(); // userId -> userName ë§¤í•‘
        
        // WebSocket ì—°ê²°
        function connect() {
            const socket = new SockJS('/ws/chat');
            stompClient = Stomp.over(socket);
            
            // ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™”
            stompClient.debug = function(str) {
                console.log('ğŸ”— STOMP Debug: ' + str);
            };
            
            stompClient.connect({}, function(frame) {
                console.log('âœ… WebSocket Connected: ' + frame);
                console.log('ğŸ¯ Current user session info:', frame.headers);
                updateConnectionStatus(true);
                
                // ì—°ê²° ì„±ê³µ ë©”ì‹œì§€ ì¶”ê°€
                addMessage('ğŸ”— WebSocket ì—°ê²° ì„±ê³µ!', 'system');
                
                // ê°œì¸ ì•Œë¦¼ êµ¬ë…ì€ joinLectureì—ì„œ ì„¤ì •ë¨
            }, function(error) {
                console.log('âŒ Connection error: ' + error);
                updateConnectionStatus(false);
            });
        }
        
        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect();
            }
            updateConnectionStatus(false);
        }
        
        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.className = 'status connected';
                status.innerHTML = 'ğŸŸ¢ ì—°ê²°ë¨';
            } else {
                status.className = 'status disconnected';
                status.innerHTML = 'ğŸ”´ ì—°ê²° ëŠê¹€';
            }
        }
        
        // ë°© ìƒì„±
        async function createRoom() {
            const roomTitle = document.getElementById('roomTitle').value;
            const roomDescription = document.getElementById('roomDescription').value;
            const userId = document.getElementById('userId').value;
            
            if (!roomTitle.trim()) {
                alert('ë°© ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!userId.trim()) {
                alert('ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                const response = await fetch('/api/rooms/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: roomTitle,
                        description: roomDescription,
                        hostUserId: parseInt(userId),
                        maxParticipants: 10,
                        isRecordingEnabled: false,
                        isOpenToEveryone: true
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // ìƒì„±ëœ ë°© ì •ë³´ í‘œì‹œ
                document.getElementById('createdRoomCode').textContent = data.roomCode;
                document.getElementById('createdRoomTitle').textContent = data.title;
                document.getElementById('createdRoomInfo').style.display = 'block';
                
                // ë°© ì½”ë“œë¥¼ ì…ì¥ í•„ë“œì— ìë™ ì…ë ¥
                document.getElementById('joinRoomCode').value = data.roomCode;
                
                addMessage(`ë°©ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: ${data.title} (ì½”ë“œ: ${data.roomCode})`, 'system');
                
                // autoJoinì´ trueë©´ ìë™ìœ¼ë¡œ ì…ì¥
                if (data.autoJoin) {
                    addMessage('ìƒì„±í•œ ë°©ì— ìë™ìœ¼ë¡œ ì…ì¥í•©ë‹ˆë‹¤...', 'system');
                    setTimeout(() => {
                        joinRoom();
                    }, 1000);
                }
                
            } catch (error) {
                console.error('ë°© ìƒì„± ì‹¤íŒ¨:', error);
                addMessage('ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'system');
            }
        }
        
        // ë°© ì…ì¥
        function joinRoom() {
            console.log('ğŸ”¥ joinRoom function called');
            
            currentUserId = document.getElementById('userId').value;
            currentUserName = document.getElementById('userName').value;
            const roomCode = document.getElementById('joinRoomCode').value;
            const userRole = document.getElementById('userRole').value;
            
            console.log('ğŸ”¥ Form values:', {currentUserId, currentUserName, roomCode, userRole});
            
            if (!currentUserId || !currentUserName || !roomCode) {
                console.log('âŒ Missing form values');
                alert('ì‚¬ìš©ì ì •ë³´ì™€ ë°© ì½”ë“œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            console.log('ğŸ”¥ Checking stompClient:', stompClient);
            if (stompClient === null) {
                console.log('ğŸ”¥ stompClient is null, connecting...');
                connect();
                setTimeout(() => joinRoom(), 1000);
                return;
            }
            
            console.log('ğŸ”¥ Setting currentRoomCode to:', roomCode);
            currentRoomCode = roomCode;
            
            // ğŸ† Clean êµ¬ë… 1: ë°© í†µí•© ë©”ì‹œì§€ (ì‹¤ì‹œê°„ + íˆìŠ¤í† ë¦¬)
            console.log('ğŸ¯ Setting up room subscription for:', roomCode);
            stompClient.subscribe(`/room/${roomCode}`, function(unifiedMessage) {
                const message = JSON.parse(unifiedMessage.body);
                handleRoomMessage(message);
            });
            
            // ğŸ† Clean êµ¬ë… 2: ê°œì¸ í†µí•© ì•Œë¦¼
            console.log('ğŸ”” Setting up notifications subscription for user:', currentUserId);
            stompClient.subscribe(`/user/queue/notifications`, function(notification) {
                const message = JSON.parse(notification.body);
                handleNotificationMessage(message);
            });
            
            console.log('âœ… Clean subscriptions set up complete (2 total)');
            
            // ë°© ì…ì¥ ë©”ì‹œì§€ ì „ì†¡
            console.log('ğŸšª Joining room:', {
                roomCode: roomCode,
                userId: parseInt(currentUserId),
                userName: currentUserName,
                userRole: userRole
            });
            
            console.log('ğŸ“¤ Sending join message to /app/room.join');
            stompClient.send('/app/room.join', {}, JSON.stringify({
                roomCode: roomCode,
                userId: parseInt(currentUserId),
                userName: currentUserName,
                userRole: userRole
            }));
            console.log('âœ… Join message sent successfully');
            
            addMessage(`ğŸšª ${currentUserName}ë‹˜ì´ ë°©ì— ì…ì¥ ì¤‘...`, 'system');
            
            // UI ì—…ë°ì´íŠ¸
            document.getElementById('chatHeader').innerText = `ğŸ’¬ ${roomCode} ë°©`;
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            if (userRole === 'INSTRUCTOR' || userRole === 'TA') {
                document.getElementById('announcementBtn').disabled = false;
            }
            
            // ì°¸ì—¬ì ëª©ë¡ ì£¼ê¸°ì  ì—…ë°ì´íŠ¸
            updateParticipants();
            setInterval(updateParticipants, 5000);
        }
        
        // ë°© í‡´ì¥
        function leaveRoom() {
            if (!currentRoomCode) return;
            
            stompClient.send('/app/room.leave', {}, JSON.stringify({
                roomCode: currentRoomCode,
                userId: parseInt(currentUserId),
                userName: currentUserName,
                userRole: document.getElementById('userRole').value
            }));
            
            currentRoomCode = null;
            document.getElementById('chatHeader').innerText = 'ğŸ’¬ ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”';
            document.getElementById('messageInput').disabled = true;
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('announcementBtn').disabled = true;
            document.getElementById('participantsList').innerHTML = '<p style="color: #bdc3c7; font-size: 12px;">ë°©ì— ì…ì¥í•´ì£¼ì„¸ìš”</p>';
        }
        
        // ë©”ì‹œì§€ ì „ì†¡
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            
            if (!content || !currentRoomCode) {
                console.log('âŒ Cannot send message:', {content, currentRoomCode});
                return;
            }
            
            const messageData = {
                roomCode: currentRoomCode,
                senderId: parseInt(currentUserId),
                senderName: currentUserName,
                content: content,
                type: 'CHAT'
            };
            
            console.log('ğŸ“¤ Sending message:', messageData);
            
            stompClient.send('/app/room.send', {}, JSON.stringify(messageData));
            
            messageInput.value = '';
            
            // ì „ì†¡ í™•ì¸ ë©”ì‹œì§€
            addMessage(`ğŸ“¤ ë©”ì‹œì§€ ì „ì†¡ ì¤‘: "${content}"`, 'system');
        }
        
        // ê³µì§€ì‚¬í•­ ì „ì†¡
        function sendAnnouncement() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            
            if (!content || !currentRoomCode) return;
            
            stompClient.send('/app/room.send', {}, JSON.stringify({
                roomCode: currentRoomCode,
                senderId: parseInt(currentUserId),
                senderName: currentUserName,
                content: content,
                type: 'ANNOUNCEMENT'
            }));
            
            messageInput.value = '';
        }
        
        // DM ì „ì†¡
        function sendDM() {
            const dmInput = document.getElementById('dmMessageInput');
            const content = dmInput.value.trim();
            
            if (!content || !currentDmPartner) return;
            
            stompClient.send('/app/dm.send', {}, JSON.stringify({
                senderId: currentUserId,
                senderName: currentUserName,
                receiverId: currentDmPartner.userId,
                receiverName: currentDmPartner.userName,
                content: content
            }));
            
            dmInput.value = '';
        }
        
        // ğŸ† í†µí•© ë°© ë©”ì‹œì§€ í•¸ë“¤ëŸ¬
        function handleRoomMessage(unifiedMessage) {
            console.log('ğŸ“¨ Received unified room message:', unifiedMessage);
            
            switch(unifiedMessage.type) {
                case 'HISTORY_SYNC':
                    console.log('ğŸ“œ Processing history sync');
                    loadRoomHistory(unifiedMessage.payload);
                    break;
                    
                case 'REALTIME_MESSAGE':
                    console.log('ğŸ’¬ Processing realtime message');
                    // íˆìŠ¤í† ë¦¬ ë¡œë”© ì¤‘ì´ë©´ íì— ì €ì¥
                    if (historyLoading) {
                        console.log('â³ History loading in progress, queuing message');
                        messageQueue.push(unifiedMessage);
                        return;
                    }
                    displayRoomMessageInternal(unifiedMessage.payload);
                    break;
                    
                case 'USER_JOIN':
                    console.log('ğŸ‘‹ Processing user join');
                    if (!historyLoading) {
                        displayRoomMessageInternal(unifiedMessage.payload);
                    }
                    break;
                    
                case 'USER_LEAVE':
                    console.log('ğŸ‘‹ Processing user leave');
                    if (!historyLoading) {
                        displayRoomMessageInternal(unifiedMessage.payload);
                    }
                    break;
                    
                case 'ANNOUNCEMENT':
                    console.log('ğŸ“¢ Processing announcement');
                    if (!historyLoading) {
                        displayRoomMessageInternal(unifiedMessage.payload);
                    }
                    break;
                    
                default:
                    console.warn('â“ Unknown room message type:', unifiedMessage.type);
            }
        }
        
        // ğŸ† í†µí•© ì•Œë¦¼ ë©”ì‹œì§€ í•¸ë“¤ëŸ¬
        function handleNotificationMessage(unifiedMessage) {
            console.log('ğŸ”” Received notification message:', unifiedMessage);
            
            switch(unifiedMessage.type) {
                case 'DM_RECEIVED':
                    console.log('ğŸ’¬ Processing DM notification');
                    showDMNotification(unifiedMessage.payload);
                    break;
                    
                case 'MENTION':
                    console.log('@ï¸ Processing mention notification');
                    // TODO: ë©˜ì…˜ ì•Œë¦¼ ì²˜ë¦¬
                    break;
                    
                case 'ROOM_INVITE':
                    console.log('ğŸ  Processing room invite');
                    // TODO: ë°© ì´ˆëŒ€ ì•Œë¦¼ ì²˜ë¦¬
                    break;
                    
                default:
                    console.warn('â“ Unknown notification type:', unifiedMessage.type);
            }
        }
        
        // ì‹¤ì œ ë©”ì‹œì§€ í‘œì‹œ ë¡œì§ (ë‚´ë¶€ í•¨ìˆ˜) - ê¸°ì¡´ê³¼ ë™ì¼
        function displayRoomMessageInternal(message) {
            let messageClass = 'other';
            if (message.senderId === currentUserId) {
                messageClass = 'own';
            } else if (message.type === 'SYSTEM' || message.type === 'JOIN' || message.type === 'LEAVE') {
                messageClass = 'system';
            } else if (message.type === 'ANNOUNCEMENT') {
                messageClass = 'announcement';
            }
            
            addMessage(`${message.senderName}: ${message.content}`, messageClass);
        }
        
        // ë©”ì‹œì§€ ì¶”ê°€
        function addMessage(content, type = 'other') {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = content;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        // ì°¸ì—¬ì ëª©ë¡ ì—…ë°ì´íŠ¸
        async function updateParticipants() {
            if (!currentRoomCode) return;
            
            try {
                const response = await fetch(`/api/chat/room/participants?roomCode=${currentRoomCode}`);
                const data = await response.json();
                
                participants.clear();
                // dataëŠ” Map<Integer, String> í˜•íƒœ (userId -> userName)
                for (const [userId, userName] of Object.entries(data)) {
                    participants.set(parseInt(userId), userName);
                }
                
                const participantsList = document.getElementById('participantsList');
                participantsList.innerHTML = '';
                
                if (participants.size === 0) {
                    participantsList.innerHTML = '<p style="color: #bdc3c7; font-size: 12px;">ì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                    return;
                }
                
                participants.forEach((userName, userId) => {
                    const participantDiv = document.createElement('div');
                    participantDiv.className = 'participant';
                    participantDiv.innerHTML = `
                        <span>${userName} (${userId})</span>
                        <button class="btn btn-primary" style="padding: 4px 8px; font-size: 12px;" onclick="openDM('${userId}', '${userName}')">DM</button>
                    `;
                    participantsList.appendChild(participantDiv);
                });
                
            } catch (error) {
                console.error('ì°¸ì—¬ì ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
            }
        }
        
        // DM ì°½ ì—´ê¸°
        function openDM(userId, userName) {
            if (userId === currentUserId) {
                alert('ìì‹ ì—ê²ŒëŠ” DMì„ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            currentDmPartner = { userId, userName };
            document.getElementById('dmPartnerName').innerText = `${userName}ë‹˜ê³¼ì˜ DM`;
            document.getElementById('dmWindow').style.display = 'flex';
            
            // DM ë°© êµ¬ë…
            const roomId = generateDMRoomId(currentUserId, userId);
            stompClient.subscribe(`/room/dm.${roomId}`, function(dmMessage) {
                const message = JSON.parse(dmMessage.body);
                displayDMMessage(message);
            });
            
            // DM íˆìŠ¤í† ë¦¬ ìš”ì²­
            stompClient.send('/app/dm.join', {}, JSON.stringify({
                userId1: currentUserId,
                userId2: userId,
                requesterId: currentUserId
            }));
        }
        
        // DM ì°½ ë‹«ê¸°
        function closeDM() {
            document.getElementById('dmWindow').style.display = 'none';
            document.getElementById('dmMessages').innerHTML = '';
            currentDmPartner = null;
        }
        
        // DM ë©”ì‹œì§€ í‘œì‹œ
        function displayDMMessage(message) {
            const dmMessages = document.getElementById('dmMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.senderId === currentUserId ? 'own' : 'other'}`;
            messageDiv.innerHTML = `${message.senderName}: ${message.content}`;
            dmMessages.appendChild(messageDiv);
            dmMessages.scrollTop = dmMessages.scrollHeight;
        }
        
        // DM ì•Œë¦¼ í‘œì‹œ
        function showDMNotification(data) {
            if (confirm(`${data.senderName}ë‹˜ìœ¼ë¡œë¶€í„° ìƒˆë¡œìš´ ë©”ì‹œì§€ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤.\n"${data.preview}"\n\nDM ì°½ì„ ì—´ê¹Œìš”?`)) {
                openDM(data.senderId, data.senderName);
            }
        }
        
        // DM íˆìŠ¤í† ë¦¬ ë¡œë“œ
        function loadDMHistory(history) {
            const dmMessages = document.getElementById('dmMessages');
            dmMessages.innerHTML = '';
            
            history.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.senderId.toString() === currentUserId ? 'own' : 'other'}`;
                messageDiv.innerHTML = `${msg.senderId === currentUserId ? 'ë‚˜' : currentDmPartner.userName}: ${msg.content}`;
                dmMessages.appendChild(messageDiv);
            });
            
            dmMessages.scrollTop = dmMessages.scrollHeight;
        }
        
        // REST API íˆìŠ¤í† ë¦¬ ë¡œë“œ í•¨ìˆ˜ ì œê±°ë¨ - WebSocketë§Œ ì‚¬ìš©

        // ë©”ì‹œì§€ í (íˆìŠ¤í† ë¦¬ ë¡œë”© ì¤‘ ë°›ì€ ì‹¤ì‹œê°„ ë©”ì‹œì§€ ì„ì‹œ ì €ì¥)
        let messageQueue = [];
        let historyLoading = false;
        
        // ë°© íˆìŠ¤í† ë¦¬ ë¡œë“œ
        function loadRoomHistory(history) {
            console.log('ğŸ”„ Loading room history:', history);
            console.log('ğŸ“Š History length:', history.length);
            
            // íˆìŠ¤í† ë¦¬ ë¡œë”© ì‹œì‘
            historyLoading = true;
            
            if (!Array.isArray(history)) {
                console.error('âŒ History is not an array:', history);
                historyLoading = false;
                return;
            }
            
            // ê¸°ì¡´ ë©”ì‹œì§€ë¥¼ ëª¨ë‘ ì§€ìš°ê³  íˆìŠ¤í† ë¦¬ë¶€í„° í‘œì‹œ
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '';
            
            // íˆìŠ¤í† ë¦¬ë¥¼ ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬ (ì˜¤ë˜ëœ ê²ƒë¶€í„°)
            const sortedHistory = history.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
            console.log('ğŸ“… Sorted history:', sortedHistory);
            
            sortedHistory.forEach((msg, index) => {
                console.log(`ğŸ’¬ Processing message ${index}:`, msg);
                let messageClass = 'other';
                let displayName = `ì‚¬ìš©ì${msg.senderId}`;
                
                if (msg.senderId.toString() === currentUserId) {
                    messageClass = 'own';
                    displayName = currentUserName || 'ë‚˜';
                } else if (msg.messageType === 'SYSTEM') {
                    messageClass = 'system';
                    displayName = '';
                } else if (msg.messageType === 'ANNOUNCEMENT') {
                    messageClass = 'announcement';
                    displayName = `[ê³µì§€] ì‚¬ìš©ì${msg.senderId}`;
                }
                
                const content = displayName ? `${displayName}: ${msg.content}` : msg.content;
                console.log(`â¡ï¸ Adding message: ${content} (class: ${messageClass})`);
                addMessage(content, messageClass);
            });
            
            addMessage('--- ì´ì „ ë©”ì‹œì§€ ë¡œë“œ ì™„ë£Œ ---', 'system');
            
            // íˆìŠ¤í† ë¦¬ ë¡œë”© ì™„ë£Œ - íì— ìˆë˜ ì‹¤ì‹œê°„ ë©”ì‹œì§€ë“¤ ì²˜ë¦¬
            historyLoading = false;
            console.log(`ğŸ“¦ Processing ${messageQueue.length} queued messages`);
            
            messageQueue.forEach(queuedMessage => {
                console.log('ğŸ“¤ Processing queued message:', queuedMessage);
                // í†µí•© ë©”ì‹œì§€ë©´ payload ì‚¬ìš©, ì•„ë‹ˆë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                if (queuedMessage.payload) {
                    displayRoomMessageInternal(queuedMessage.payload);
                } else {
                    displayRoomMessageInternal(queuedMessage);
                }
            });
            messageQueue = []; // í ë¹„ìš°ê¸°
            
            console.log('âœ… Room history loading completed');
        }
        
        // DM ë°© ID ìƒì„± (DirectMessage.javaì™€ ë™ì¼í•œ ë¡œì§)
        function generateDMRoomId(userId1, userId2) {
            return userId1 < userId2 ? `dm_${userId1}_${userId2}` : `dm_${userId2}_${userId1}`;
        }
        
        // Enter í‚¤ ì´ë²¤íŠ¸
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        document.getElementById('dmMessageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendDM();
            }
        });
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì—°ê²°
        window.addEventListener('load', function() {
            // ì´ˆê¸° ì—°ê²°ì€ ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ í•˜ë„ë¡ ë³€ê²½
        });
        
        window.addEventListener('beforeunload', function() {
            if (currentRoomCode) {
                leaveRoom();
            }
            disconnect();
        });
    </script>
</body>
</html>